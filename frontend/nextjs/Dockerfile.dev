# Use a specific Node.js version for better stability
FROM node:18.17.0-alpine

# Set environment variables for production and memory limits
ENV NODE_ENV=production
ENV NODE_OPTIONS="--max-old-space-size=512"
ENV PORT=3000

# Add package mirrors for improved reliability
RUN echo "registry=https://registry.npmjs.org/" > ~/.npmrc && \
    echo "network-timeout=60000" >> ~/.npmrc && \
    npm config set fetch-retries 3 && \
    npm config set fetch-retry-mintimeout 5000 && \
    npm config set fetch-retry-maxtimeout 60000

WORKDIR /app

# Copy package files first for better layer caching
COPY package.json ./

# Install dependencies with optimized settings
RUN npm install --production=false --legacy-peer-deps --no-fund --loglevel=error

# Copy the rest of the application
COPY . .

# Build the application with production settings
RUN npm run build

# Set up for production runtime
EXPOSE 3000

# Start the application in production mode with standalone output
CMD ["node", ".next/standalone/server.js"]